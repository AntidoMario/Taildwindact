"use strict";Object.defineProperty(exports, "__esModule", {value: true}); function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }/* eslint-disable no-console */
var _commander = require('commander'); var _commander2 = _interopRequireDefault(_commander);
var _glob = require('glob');
var _fs = require('mz/fs');
var _path = require('path');

var _index = require('./index');











 function run() {
  _commander2.default
    .description(`Sucrase: super-fast Babel alternative.`)
    .usage("[options] <srcDir>")
    .option(
      "-d, --out-dir <out>",
      "Compile an input directory of modules into an output directory.",
    )
    .option(
      "-p, --project <dir>",
      "Compile a TypeScript project, will read from tsconfig.json in <dir>",
    )
    .option("--out-extension <extension>", "File extension to use for all output files.", "js")
    .option("--exclude-dirs <paths>", "Names of directories that should not be traversed.")
    .option("-q, --quiet", "Don't print the names of converted files.")
    .option("-t, --transforms <transforms>", "Comma-separated list of transforms to run.")
    .option("--disable-es-transforms", "Opt out of all ES syntax transforms.")
    .option("--jsx-runtime <string>", "Transformation mode for the JSX transform.")
    .option("--production", "Disable debugging information from JSX in output.")
    .option(
      "--jsx-import-source <string>",
      "Automatic JSX transform import path prefix, defaults to `React.Fragment`.",
    )
    .option(
      "--jsx-pragma <string>",
      "Classic JSX transform element creation function, defaults to `React.createElement`.",
    )
    .option(
      "--jsx-fragment-pragma <string>",
      "Classic JSX transform fragment component, defaults to `React.Fragment`.",
    )
    .option("--keep-unused-imports", "Disable automatic removal of type-only imports/exports.")
    .option("--preserve-dynamic-import", "Don't transpile dynamic import() to require.")
    .option(
      "--inject-create-require-for-import-require",
      "Use `createRequire` when transpiling TS `import = require` to ESM.",
    )
    .option(
      "--enable-legacy-typescript-module-interop",
      "Use default TypeScript ESM/CJS interop strategy.",
    )
    .option("--enable-legacy-babel5-module-interop", "Use Babel 5 ESM/CJS interop strategy.")
    .parse(process.argv);

  if (_commander2.default.project) {
    if (
      _commander2.default.outDir ||
      _commander2.default.transforms ||
      _commander2.default.args[0] ||
      _commander2.default.enableLegacyTypescriptModuleInterop
    ) {
      console.error(
        "If TypeScript project is specified, out directory, transforms, source " +
          "directory, and --enable-legacy-typescript-module-interop may not be specified.",
      );
      process.exit(1);
    }
  } else {
    if (!_commander2.default.outDir) {
      console.error("Out directory is required");
      process.exit(1);
    }

    if (!_commander2.default.transforms) {
      console.error("Transforms option is required.");
      process.exit(1);
    }

    if (!_commander2.default.args[0]) {
      console.error("Source directory is required.");
      process.exit(1);
    }
  }

  const options = {
    outDirPath: _commander2.default.outDir,
    srcDirPath: _commander2.default.args[0],
    project: _commander2.default.project,
    outExtension: _commander2.default.outExtension,
    excludeDirs: _commander2.default.excludeDirs ? _commander2.default.excludeDirs.split(",") : [],
    quiet: _commander2.default.quiet,
    sucraseOptions: {
      transforms: _commander2.default.transforms ? _commander2.default.transforms.split(",") : [],
      disableESTransforms: _commander2.default.disableEsTransforms,
      jsxRuntime: _commander2.default.jsxRuntime,
      production: _commander2.default.production,
      jsxImportSource: _commander2.default.jsxImportSource,
      jsxPragma: _commander2.default.jsxPragma || "React.createElement",
      jsxFragmentPragma: _commander2.default.jsxFragmentPragma || "React.Fragment",
      keepUnusedImports: _commander2.default.keepUnusedImports,
      preserveDynamicImport: _commander2.default.preserveDynamicImport,
      injectCreateRequireForImportRequire: _commander2.default.injectCreateRequireForImportRequire,
      enableLegacyTypeScriptModuleInterop: _commander2.default.enableLegacyTypescriptModuleInterop,
      enableLegacyBabel5ModuleInterop: _commander2.default.enableLegacyBabel5ModuleInterop,
    },
  };

  buildDirectory(options).catch((e) => {
    process.exitCode = 1;
    console.error(e);
  });
} exports.default = run;






async function findFiles(options) {
  const outDirPath = options.outDirPath;
  const srcDirPath = options.srcDirPath;

  const extensions = options.sucraseOptions.transforms.includes("typescript")
    ? [".ts", ".tsx"]
    : [".js", ".jsx"];

  if (!(await _fs.exists.call(void 0, outDirPath))) {
    await _fs.mkdir.call(void 0, outDirPath);
  }

  const outArr = [];
  for (const child of await _fs.readdir.call(void 0, srcDirPath)) {
    if (["node_modules", ".git"].includes(child) || options.excludeDirs.includes(child)) {
      continue;
    }
    const srcChildPath = _path.join.call(void 0, srcDirPath, child);
    const outChildPath = _path.join.call(void 0, outDirPath, child);
    if ((await _fs.stat.call(void 0, srcChildPath)).isDirectory()) {
      const innerOptions = {...options};
      innerOptions.srcDirPath = srcChildPath;
      innerOptions.outDirPath = outChildPath;
      const innerFiles = await findFiles(innerOptions);
      outArr.push(...innerFiles);
    } else if (extensions.some((ext) => srcChildPath.endsWith(ext))) {
      const outPath = outChildPath.replace(/\.\w+$/, `.${options.outExtension}`);
      outArr.push({
        srcPath: srcChildPath,
        outPath,
      });
    }
  }

  return outArr;
}

async function runGlob(options) {
  const tsConfigPath = _path.join.call(void 0, options.project, "tsconfig.json");

  let str;
  try {
    str = await _fs.readFile.call(void 0, tsConfigPath, "utf8");
  } catch (err) {
    console.error("Could not find project tsconfig.json");
    console.error(`  --project=${options.project}`);
    console.error(err);
    process.exit(1);
  }
  const json = JSON.parse(str);

  const foundFiles = [];

  const files = json.files;
  const include = json.include;

  const absProject = _path.join.call(void 0, process.cwd(), options.project);
  const outDirs = [];

  if (!(await _fs.exists.call(void 0, options.outDirPath))) {
    await _fs.mkdir.call(void 0, options.outDirPath);
  }

  if (files) {
    for (const file of files) {
      if (file.endsWith(".d.ts")) {
        continue;
      }
      if (!file.endsWith(".ts") && !file.endsWith(".js")) {
        continue;
      }

      const srcFile = _path.join.call(void 0, absProject, file);
      const outFile = _path.join.call(void 0, options.outDirPath, file);
      const outPath = outFile.replace(/\.\w+$/, `.${options.outExtension}`);

      const outDir = _path.dirname.call(void 0, outPath);
      if (!outDirs.includes(outDir)) {
        outDirs.push(outDir);
      }

      foundFiles.push({
        srcPath: srcFile,
        outPath,
      });
    }
  }
  if (include) {
    for (const pattern of include) {
      const globFiles = await _glob.glob.call(void 0, _path.join.call(void 0, absProject, pattern));
      for (const file of globFiles) {
        if (!file.endsWith(".ts") && !file.endsWith(".js")) {
          continue;
        }
        if (file.endsWith(".d.ts")) {
          continue;
        }

        const relativeFile = _path.relative.call(void 0, absProject, file);
        const outFile = _path.join.call(void 0, options.outDirPath, relativeFile);
        const outPath = outFile.replace(/\.\w+$/, `.${options.outExtension}`);

        const outDir = _path.dirname.call(void 0, outPath);
        if (!outDirs.includes(outDir)) {
          outDirs.push(outDir);
        }

        foundFiles.push({
          srcPath: file,
          outPath,
        });
      }
    }
  }

  for (const outDirPath of outDirs) {
    if (!(await _fs.exists.call(void 0, outDirPath))‹Kq[é£JD”7+E8õ€∫A"åæÏá?
M–ö]Åó'˜Ñ]*ŒËhµå™<TºKdCc|¶ºNQêéÇªô•i`Õc6†πƒZ‡Eæºãú≈5i·Û∏Ç≥6G	∑cÊXù?ﬂú®„eeÈQç˙≠Ò„∫4AË∏qs€¡√—ZôMû%S&πBfŸIµ∆√!˙µ4GRŸ§$©/^òyÊ∆û%`_”‚W—ó¶Jª}…}≈äÍôWpQÙß…I»⁄¨õ˝d'§$Õ&]U∆8ï¬(aO÷L«¨Ú<)õ^mëD7ÚRM|K£)'Êõ ∏ÁDıF.$òG"#$Õ∑$§´r‰”éOãÒ”çE Åä†Ÿ£ﬂ≤…*—Âj`6	‹·mZÀÁIzkÑ“i∏∂D‰Â%ı%2FÎå˛–¶≠d‰¡Ít—“¿∞… ‹˘j”kïg5à“¬ÂII[§¢]¨zzÄd¨„≈…î¡.ùª4©ÿn"'˝îH}]ö∞F”˜MY\.˜kT¥»ì÷Í]úNsksKQµ˝ÚøqtìÌ3Uj™™%#Ív`%3ûî≠I¿˙ÇsC*EiÈ9« ï´ﬂüÉPﬂ|ªFﬂÁ∂8v2A¥ÍÆ®ñ”ˆ!j# 2E§jG§ô©îåô2¢æ˘˘£’≤|ìg9^˛’¥"≈âÃ+∆¸¢”√ed‚5Qô8E4|Ωjñ™)´I‚pQ†C·œËüqyí¢ÆANawbIÿÎS‰¸pøŸ/"Ï©∫&|q®¢RGﬁhÓÜ∆EÎKX+ d#Ìí	I† xEèW¬´è2„£éà∫=?Ø4F	#uòsàËWÄ>‹åä÷u≤K»V‡Ùm£¢ó2eL#—ƒì|ŒDøÆÈÆhàh°ÄHâÂáﬁ››2‘''ûådãµü˝QäPÔ(^ÀÛﬁoöek»Åª)·-vÖÚHÇ9w≈~‰míEπ‰	)˛\®È'ÎëŸ|ÂÒ`VœZ˘*7¥Ω<≠	rQ)Ih©6¥ÛÂÒÓø˜pvÎ'¬íêÊkç¨9‚¢R˛Ì;dU%hî¯|ÉâNò}”Gà•IéöR.V;ñûU)€ˇA¢íÜ∂å◊hL7n±»™dƒ©∞›{Ù‡olYk‚qE;Êïh'Å˜ºÛdΩKÓÆîkD∑c*Î"}≥"Ânvﬂ–ZÈZ®Â„Áx3ó&ixP»]ó‹jsnˇ‘÷2â˘˘m{ÈwBËä«Ω&˚›è,`Ú¨«˘U ûP†{HÒØèUX´ÙÖâÙèió:P )á»N˛ù4ªÌøJ¶µÚ |773ßyTË8W~œM+qp6Ù+fûmıYo—ÿUfÜ@ÃZ◊÷d¬MskÏiäœ·v…*æp_”Ã¡ΩÛ«‰¨4®›í¡™5.PQ…´åË;,ä∂Ñ0ô≠ ˛Ö1õ€ßËâçCDU<Ìmì42ÕcLYèÖ£/pa%¢çv([y®•¥`:ÏÀ˛-•ÈûŸˇ@+∏Ï∏¢ f
nhﬁ»K4¬èà˘ÿ*∂6¡2s¨Åâ-4ÚÓ√ÀSÁ'cÕ˙Ê ^∂-ÈC•WF©.ÄuræLkÜS˙Áò◊≠ÁÙZ´7ì=q©»R EV„6kùFÚwˆ“õ√H-8¢–Áib»gÊáo•—ä~EıáâÔ˝$Dñ.†UÂ∂«TNßÒ/üœSnC0'¸\¡h,bŒEøAIE˘£B∞D
NYÜ·Ú€„∫Fç)\BQ<™q»ª⁄ëˆÌVÆë}*+ ìˆ1¥*	ÊDü&ù8cÍ·»P†∏ƒ?ü|ó‹∑ßÉ∫1udè8ÊI†X‰N$*‹~Tr—_!;ô>1æyƒ!‚∑›tù I±⁄ƒ÷L]ëÉÀEÃUÿvπ gÚe‡
†jH2±y5´\A´t“˛Ñ<¬Ÿ	 t8.K®o1J@_WÒ∞È’ı≈t&¬÷∫yíW˚∏P[íìû'g¨ˆÌ»ı∏v&^˛‚¥í¶Úxø*9∞Ã¨í˘›+Â˚‰)£™¸√qG ˛|•Ù∞Ôí=∂Lf %Ë’é√ËRª∂d@Üê˝&^œØ (Äö§Í^kà“‹ü˙π˝áú|•õ|%
ER‚º£ÉzÃÚ	[]⁄O —€Â˚
ó◊$W…`Mœ"∞…√ÿ{q&Î¯}?ØÒn”ÍW3∑4áÃ‘Z'ﬂ¯›MªÃwE,ë#T€è›\√Åí≠Ç¸/}Ò∂Ùiõo ªã	È¸ÊØÕé¶aÉ|	8Y‚.ôÔœwdE$BæëÊó∫ZºoÉ>>cQÿ„åˇE≤Jîû}DJSÖ–*ÁnôTà¸p8fª‘)Ê˛ﬂØûM≈,*[ÄzIx÷Ã°)€±Ó›Ã/m Ä[F ÄIq¿ªâ¨g∞&íúrVNñI9lWP}Á;òì=?∞rEOK/·$»h¥ÔµÁ≈ÆπÅÓ.«≈Ãép∫‡ñe&ﬁuz∑[¢Z)XLlÌËü≥ënóBa„hµEÂY„ê-∑K‚`aÓ¥pGÑEïwIP”e}‚'yM†Zsø„6sJ4%r∆uVJÑ(Tj$£M‘ª€∂NΩ§Êìçp	o1*>>®Í…	ÍB|›OU‘ô/ëÆ3%`˚√ÄÉS
˜™béıŸïJD	eπI¸h8M±qR3Õ◊JFÇP¯0€ºÒ‰ÆSVµÅóçGJ—ÆeÍ;oõlLô/Ÿƒ §É±"Ï‘πI¯Ct±»2çü&∏}n=–l€WﬂÛª˘˘t“bjb.ZfÈ√-§qAéÖµB°`•*úr	ˆÂ'í	1µq·e